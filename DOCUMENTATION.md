# Техническая документация: Система бронирования (Frontend)

## 1. Введение

Этот документ описывает frontend-часть приложения "Система бронирования". Приложение представляет собой одностраничный веб-интерфейс (SPA), предназначенный для работы в качестве Telegram Web App. Оно позволяет пользователям создавать, просматривать и управлять заявками на бронирование, а администраторам — модерировать все заявки.

**Основные функции:**
- Авторизация пользователя через Telegram ID.
- Просмотр списка своих бронирований с сортировкой.
- Создание новой заявки на бронирование через подробную форму.
- Редактирование существующих заявок.
- Просмотр календаря занятости с информацией о загрузке по дням.
- Панель администрирования для просмотра и управления всеми заявками.
- Система комментариев к заявкам.
- Экспорт данных в Excel (функциональность реализуется на стороне бэкенда).

## 2. Архитектура

Приложение имеет классическую **клиент-серверную архитектуру**.

- **Frontend (данный репозиторий):**
  - Полностью статическое приложение, написанное на HTML, CSS и JavaScript.
  - Отвечает за отрисовку интерфейса, обработку действий пользователя и взаимодействие с бэкендом через REST API.
  - Вся логика и состояние управляются в файле `app.js`.

- **Backend (внешний сервис):**
  - Приложение не может функционировать без бэкенда. Бэкенд предоставляет REST API для всех операций с данными.
  - Текущий URL бэкенда: `https://schedule.neuroprom.com/api` (надо поменять на свой).
  - Бэкенд отвечает за бизнес-логику, хранение данных в базе, проверку прав доступа (администратор/пользователь) и генерацию отчетов.

## 3. Технологический стек

- **HTML5:** Структура и разметка страниц.
- **CSS3:** Стилизация, включая использование Flexbox, Grid и Media Queries для адаптивности.
- **JavaScript (ES6+):** Вся клиентская логика, включая асинхронные запросы (`fetch`).
- **Библиотеки:**
  - `telegram-web-app.js`: Официальная библиотека для интеграции с клиентом Telegram.
  - `xlsx.full.min.js`: Библиотека для работы с Excel-файлами. **Примечание:** Несмотря на то, что библиотека подключена в `index.html`, текущая реализация экспорта (`exportCalendarToExcel`) отправляет запрос на бэкенд, который генерирует и отправляет файл пользователю. Библиотека может быть задействована в будущем или для других, нереализованных функций.
- **Платформа развертывания:**
  - [Vercel](https://vercel.com): Платформа для хостинга статических сайтов и serverless-функций.

## 4. Начало работы и локальная разработка

Поскольку проект не использует системы сборки (Webpack, Vite) или менеджеры пакетов (npm, yarn), его запуск в режиме разработки очень прост.

**Шаг 1: Клонирование репозитория**
```bash
git clone <URL_вашего_репозитория>
cd <название_папки_проекта>
```

**Шаг 2: Запуск локального веб-сервера**
Для работы приложения (в частности, для `fetch`-запросов) его необходимо открывать не как локальный файл (`file:///...`), а через веб-сервер.

**Шаг 3: Режим отладки**
- Приложение определяет, запущено ли оно внутри Telegram. Если нет, оно переходит в режим отладки.
- В этом режиме появится `prompt`-окно с запросом **"Enter User ID"**.
- Введите любой числовой ID (например, `12345`) для имитации обычного пользователя.
- Чтобы протестировать функционал администратора, необходимо ввести ID, который зарегистрирован в базе данных бэкенда как администраторский.

## 5. Конфигурация

Единственный и самый важный конфигурационный параметр находится в файле `app.js`.

```javascript
// app.js, строка 2
const apiUrl = 'https://schedule.neuroprom.com/api';
```

Если адрес бэкенд-сервиса изменится, его необходимо обновить в этой константе.

## 6. Взаимодействие с API

Всё взаимодействие с бэкендом осуществляется через `fetch`-запросы. Идентификация пользователя происходит путем передачи его Telegram ID в HTTP-заголовке `user-id` в каждом запросе.

**Ключевые эндпоинты:**
- `GET /users/check-admin`: Проверяет, является ли пользователь с переданным `user-id` администратором.
- `GET /bookings`: Получает список бронирований. Для администратора возвращает все, для обычного пользователя — только его. Поддерживает query-параметры `?sort_by=` и `?sort_order=`.
- `GET /bookings/calendar`: Получает агрегированные данные для отображения в календаре (количество людей и темы по дням).
- `POST /bookings`: Создает новое бронирование. Данные передаются в теле запроса в формате JSON.
- `PUT /bookings/{id}`: Обновляет существующее бронирование по его `id`.
- `DELETE /bookings/{id}`: Удаляет/отменяет бронирование.
- `PATCH /bookings/{id}/approve`: (Только для админов) Одобряет заявку.
- `PATCH /bookings/{id}/reject`: (Только для админов) Отклоняет заявку.
- `POST /bookings/{id}/comments`: Добавляет новый комментарий к бронированию.
- `GET /export/excel/`: Инициирует экспорт данных на стороне бэкенда. Бэкенд формирует Excel-файл и отправляет его пользователю (вероятно, через Telegram-бота).

## 7. Структура кода

Проект имеет простую структуру, состоящую из трех файлов. Ниже приведено подробное описание каждого из них.

### `index.html`

Это единственный HTML-файл, который служит каркасом для всего одностраничного приложения (SPA).

-   **Структура:** Содержит базовую разметку, подключение стилей (`styles.css`) и скриптов (`app.js`, а также внешних библиотек).
-   **Ключевые блоки:**
    -   `#auth-section`: Отображается при загрузке, пока идет проверка авторизации пользователя.
    -   `#user-actions`: Основной контейнер, который становится видимым после успешной авторизации. Включает в себя всю интерактивную часть приложения.
    -   **Система вкладок (Tabs):**
        -   Кнопки (`.tab-btn`) с атрибутом `data-tab` для переключения.
        -   Контейнеры для контента (`.tab-content`), которые отображаются или скрываются в зависимости от активной вкладки.
    -   **Формы:**
        -   `#create-booking-form`: Форма для создания новой заявки.
        -   `#edit-booking-form`: Форма для редактирования, находится внутри модального окна.
    -   **Модальные окна (`.modal`):**
        -   `#edit-modal`: Для редактирования заявки.
        -   `#booking-details-modal`: Для просмотра полной информации о заявке и комментариев.
        -   `#calendar-day-popover`: Всплывающее окно для отображения информации о конкретном дне в календаре.
-   **Идентификаторы (`id`):** Широко используются для всех интерактивных элементов (кнопок, полей ввода, таблиц, контейнеров), что позволяет легко обращаться к ним из `app.js` через `document.getElementById()`.
-   **Условное отображение:** Классы `.admin-only` и `.admin-only-field` используются для элементов, которые должны быть видны только администраторам. Логика их отображения/скрытия реализована в `app.js`.

### `styles.css`

Этот файл содержит все стили приложения.

-   **Методология:** Стили написаны на чистом CSS без препроцессоров. Используются классы для стилизации компонентов (кнопки, таблицы, формы).
-   **Адаптивность:** Реализована с помощью `@media screen and (max-width: ...)` для корректного отображения на мобильных устройствах. Основные точки перелома (breakpoints) — 768px и 480px.
-   **Визуальные состояния:** Определены стили для различных состояний, например:
    -   `.status-pending`, `.status-approved`, `.status-rejected` для визуального выделения статуса заявки.
    -   `.booked-full`, `.booked-partial` для раскраски дней в календаре.
    -   Псевдоклассы `:hover`, `:focus` для интерактивных элементов.

### `app.js`

Это "мозг" приложения, где сосредоточена вся бизнес-логика и взаимодействие с пользователем.

#### Ключевые концепции

-   **"Ванильный" JavaScript:** Код написан без использования фреймворков (React, Vue, etc.).
-   **Глобальное состояние:** Состояние приложения (ID пользователя, его права, загруженные данные) хранится в глобальных переменных (`userId`, `isAdmin`, `currentUserBookings`, и т.д.).
-   **Событийная модель:** Приложение реагирует на действия пользователя (клики, отправка форм), вызывая соответствующие функции-обработчики.

#### Жизненный цикл приложения (при загрузке)

1.  **`init()`**: Главная функция, запускающаяся при загрузке скрипта.
2.  Определяется среда: запущено ли приложение в Telegram (`isTelegramWebApp()`).
3.  Получается `userId` из объекта Telegram или через `prompt()` для отладки.
4.  Вызывается `checkAdminStatus()` — асинхронный запрос к API для определения прав пользователя.
5.  На основе `isAdmin` скрываются/отображаются элементы с классом `.admin-only`.
6.  Скрывается блок `#auth-section` и отображается `#user-actions`.
7.  Вызывается `setupEventListeners()` для "оживления" всех кнопок, форм и интерактивных элементов.
8.  Вызывается `loadInitialData()` для предзагрузки данных (например, для календаря).
9.  Программно "нажимается" первая вкладка ("Мои бронирования").

#### Основные модули и функции

-   **Управление состоянием и глобальные переменные:**
    -   `apiUrl`: URL бэкенд-сервиса.
    -   `userId`, `isAdmin`: Данные текущего пользователя.
    -   `currentMonth`, `currentYear`: Состояние для навигации в календаре.
    -   `calendarApiData`, `currentUserBookings`, `allAdminBookings`: Кэши для данных, полученных с сервера, чтобы избежать повторных запросов.

-   **Взаимодействие с API (CRUD и другие запросы):**
    -   `fetchWithHandling()`: Централизованная функция-обертка для `fetch`. Обрабатывает ошибки сети и HTTP-статусы, отличные от 2xx, возвращая текст ошибки из JSON-ответа сервера.
    -   `loadUserBookings()`, `loadAdminBookings()`, `loadCalendarData()`: Асинхронные функции, которые получают данные с сервера, используя `fetchWithHandling`.
    -   `createBooking()`, `updateBooking()`, `deleteBooking()`: Функции, отправляющие `POST`, `PUT`, `DELETE` запросы для управления заявками.
    -   `approveBooking()`, `rejectBooking()`: Отправляют `PATCH` запросы для изменения статуса заявки.

-   **Отрисовка данных (Рендеринг):**
    -   `renderBookings()`: Принимает массив заявок и генерирует строки (`<tr>`) для таблицы. Динамически создает кнопки действий (`"Редактировать"`, `"Отменить"`) и привязывает к ним `onclick` с `id` соответствующей заявки.
    -   `renderCalendar()`: Более сложная функция. Строит сетку календаря на основе `currentMonth` и `currentYear`. Проходит по `calendarApiData` и добавляет соответствующие CSS-классы (`booked-full`, `booked-partial`) к ячейкам дней.

-   **Логика UI (Формы, Модальные окна, Календарь):**
    -   `setupEventListeners()`: Навешивает все обработчики событий (`click`, `submit`, `change`) на элементы DOM.
    -   `openBookingDetailsModal()`, `showEditForm()`: Заполняют модальные окна данными из конкретного объекта заявки перед их отображением.
    -   `closeModal()`: Закрывает модальное окно по ID.
    -   `handleCalendarDayClick()`: Обрабатывает клик по дню в календаре, позиционирует и показывает/скрывает всплывающее окно (`#calendar-day-popover`) с деталями.

-   **Вспомогательные утилиты:**
    -   `getBookingDataFromForm(formPrefix)`: Важная функция, которая собирает данные из полей формы создания или редактирования. Использование `formPrefix` позволяет переиспользовать одну и ту же логику для двух разных форм (`id="theme"` и `id="edit-theme"`). Проводит базовую валидацию на наличие обязательных полей.
    -   `showLoading()`, `hideLoading()`, `showError()`, `hideError()`: Управляют отображением индикаторов загрузки и сообщений об ошибках.
    -   `formatDateForDisplay()`, `translateStatus()`: Форматируют данные для удобного отображения пользователю.

## 8. Развертывание

Приложение в настоящее время развернуто на платформе **Vercel**. Это идеальный выбор для статических сайтов, так как он обеспечивает простое развертывание, глобальный CDN и автоматические HTTPS-сертификаты.

**Процесс развертывания с помощью Vercel CLI:**

1. **Установка Vercel CLI:**
   Если у вас не установлен интерфейс командной строки Vercel, установите его глобально через npm:
   ```bash
   npm install -g vercel
   ```

2. **Авторизация:**
   Войдите в свой аккаунт Vercel:
   ```bash
   vercel login
   ```
   Вам будет предложено авторизоваться через браузер.

3. **Развертывание проекта:**
   Перейдите в корневую директорию вашего проекта и выполните команду:
   ```bash
   vercel --prod
   ```
   - `vercel`: Команда для запуска процесса развертывания.
   - `--prod`: Флаг, указывающий, что вы создаете **production**-сборку, которая будет привязана к основному домену вашего проекта на Vercel.

   Vercel автоматически определит, что это статический проект (по наличию `index.html` и отсутствию `package.json` с командами сборки), и развернет его без дополнительной конфигурации.

   После выполнения команды Vercel предоставит вам ссылку на развернутое приложение.